<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="data:image/png;base64,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">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第六河川局-防汛志工年度統計</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js" integrity="sha512-uMtXmF28A2Ab/JJO2t/vYhlaa/3ahUOgj1Zf27M5rOo8/+fcTUVH0/E0ll68njmjrLqOBjXM3V9NiPFL5ywWPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <div id="app">

        <div v-show="isAdmin">
    
            <label for="fruit">選擇分隊：</label>
            <select v-model="selectedSquad" id="fruit" v-on:change="getSquadMembers">
                <option 
                    v-for="squad of squadInfo" 
                    v-bind:value="squad.squad" 
                >
                {{ squad.squad }}

                </option>
            </select>

            <select id="members" v-model="targetUserId" v-on:change="changeUserName($event)">
                <option v-for="member of squadMembers" 
                        v-bind:value="member.user_id"
                        
                >
                        
            {{ member.v_id }} {{ member.v_name.replace(/^(.{1})./, "$1O") }}</option>
            </select>

            <p>你選擇了：{{ selectedSquad }} {{ targetUserName }} {{ targetUserId }}</p>
        </div>



        <h2>防汛志工-{{ year }}年度個人時數統計</h2>

        <h3>{{ targetUserName }} 先進好，以下是您的通報時數</h3>

        <div style="display: flex; justify-content: center;">
            <table style="width: 90%; text-align:center;">
                <colgroup>
                    <col style="background-color: lightblue;">
                    <col span="2" style="background-color: lightgreen;">
                    <col span="2" style="background-color: rgba(45, 32, 222, 0.33);">
                    <col style="background-color: rgba(54, 171, 79, 0.768);">
                </colgroup>
                <thead style="background-color: lightblue;">
                    <tr>
                        <th>月份</th>
                        <th>時數-日常</th>
                        <th>時數-通報</th>
                        <th>全勤-日常</th>
                        <th>全勤-事件</th>
                        <th>總時數</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="row of statisticsData.data" :key="row.month">
                        <td>{{ row.month }}</td>
                        <td>{{ row.routine }}</td>
                        <td>{{ row.event }}</td>
                        <td>{{ row.routine_manual ?? '是' }}</td>
                        <td>{{ row.event_manual ?? '是' }}</td>
                        <td>{{ row.total }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h3>總通報時數為: {{ totalHour }}小時</h3>
    </div>


    <script>
        const {
            createApp,
            ref
        } = Vue

        createApp({
            setup() {
                const urlParams = new URLSearchParams(window.location.search);
                const liffId = '2000002087-w65yOOAG'
                const year = urlParams.get('year') || '2023';
                const TLD = "https://wra06-volunteer.aws-gov.org"
                const profile = ref({})
                const totalHour = ref(0)
                const isAdmin = ref(false)
                const squadInfo = ref([])
                const selectedSquad = ref('')
                const squadMembers = ref([])
                const targetUserName = ref('')
                const targetUserId = ref('')
                const statisticsData = ref({
                    data: {
                        month: '01',
                        routine: 0,
                        event: 0,
                        total: 0
                    }
                })

                const checkIsAdmin = async(userId) => {
                    const url = `${ TLD }/validation/check_is_admin?user_id=${ userId }`
                    const response = await axios.get(url)
                    console.log('是否為：', response.data)
                    isAdmin.value = response.data
                }


                const initLIFF = async() => {
                    try {
                        await liff.init({
                            liffId: liffId,
                            withLoginOnExternalBrowser: true
                        });
                        profile.value = await liff.getProfile()
                        targetUserName.value = isAdmin.value ? profile.value.displayName.replace(/^(.{1})./, "$1O") : profile.value.displayName
                        targetUserId.value = profile.value.userId
                        checkIsAdmin(profile.value.userId)

                    } catch (error) {
                        console.error(error);
                    }
                    
                }


                const getStatisticData = async() => {
                    const userId = profile.value.userId
                    const url = `${ TLD }/annual/statistics/${ year }?user_id=${ userId }`
                    const response = await axios.get(url)
                    statisticsData.value = response.data
                    totalHour.value = statisticsData.value.data.reduce((acc, row) => acc + row.total, 0)
                }

                const getSquadInfo = async() => {
                    const userId = profile.value.userId
                    const url = `${ TLD }/squad/info`
                    const response = await axios.get(url)
                    squadInfo.value = response.data
                }

                const getSquadMembers = ()=> {
                    const members = squadInfo.value.filter(squad => {
                            targetUserName.value = ''
                            targetUserId.value = ''
                            return squad.squad === selectedSquad.value
                        }
                    )
                    squadMembers.value = members.length ? members[0].data : []
                }

                const changeUserName = async function(event){
                    const eventUserId = event.target.value
                    const targetUser = squadMembers.value.filter(member => member.user_id === eventUserId)
                    targetUserName.value = members.length ? targetUser[0].v_name.replace(/^(.{1})./, "$1O") : '查無此人'

                    const url = `${ TLD }/annual/statistics/${ year }?user_id=${ eventUserId }`
                    const response = await axios.get(url)
                    statisticsData.value = response.data
                    totalHour.value = statisticsData.value.data.reduce((acc, row) => acc + row.total, 0)
                }

                initLIFF()
                checkIsAdmin()
                getSquadInfo()
                getStatisticData()

                return {
                    year,
                    profile,
                    statisticsData,
                    totalHour,
                    isAdmin, 
                    squadInfo,
                    selectedSquad,
                    getSquadMembers,
                    squadMembers,
                    targetUserName,
                    targetUserId,
                    changeUserName
                }
            }
        }).mount('#app')
    </script>
</body>

</html>